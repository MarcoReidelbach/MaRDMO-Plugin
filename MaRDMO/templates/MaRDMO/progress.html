{% extends 'core/page.html' %}
{% load i18n %}
{% load static %}

{% block page %}
<div align="center">
    <br><br><br><br><br><br><br>

    <!-- Logo Progress Section -->
    <figure style="display: inline-block; position: relative;">
        <img src="{% static 'MaRDMO/images/MaRDMOLogo.png' %}" 
             style="display: block; filter: grayscale(100%);" 
             alt="Logo">
        <div id="coloredContainer" 
             style="position: absolute; top: 0; left: 0; width: 0%; height: 100%; overflow: hidden; transition: width 0.5s ease;">
            <img src="{% static 'MaRDMO/images/MaRDMOLogo.png' %}" 
                 style="display: block;"
                 alt="Colored Logo">
        </div>
    </figure>

    <br><br><br>

    <!-- Status Text -->
    <div id="status" style="font-size: 30px; font-weight: bold; margin-top: 40px;">
        Starting...
    </div>

    <!-- Attribution -->
    <div align="center" style="margin-top: 50px; font-size: 14px; color: grey;">
        <p>
            MaRDMO Logo by 
            <a href="https://www.mardi4nfdi.de/about/mission" target="_blank" style="color: grey;">
                MaRDI
            </a>, licensed under 
            <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" style="color: grey;">
                CC BY-NC-ND 4.0
            </a>.
        </p>
    </div>
</div>

<style>
  /* Each line (items/statements) stays on one line */
  .status-line {
    white-space: nowrap;
    text-align: center;
  }

  /* Reserve a bit of width for dots so text doesn't move */
  .dots {
    display: inline-flex;
    width: 1.5em;
    justify-content: left;
  }

  @keyframes blink {
    0%, 80% { opacity: 0.1; }
    30% { opacity: 1; }
  }

  .blink {
  animation: blink 1.8s infinite ease-in-out;
}
</style>

<script>
const jobId = "{{ job_id }}";
const coloredContainer = document.getElementById("coloredContainer");
const status = document.getElementById("status");

// Use Django to generate the correct JSON status URL
const progressStatusUrl = "{% url 'get_progress' job_id=job_id %}";

function getDotHTML() {
  return `
    <span class="dots">
      <span class="blink" style="animation-delay:0s;">.</span>
      <span class="blink" style="animation-delay:0.3s;">.</span>
      <span class="blink" style="animation-delay:0.6s;">.</span>
    </span>
  `;
}

async function updateProgress() {
  const res = await fetch(progressStatusUrl);
  const data = await res.json();

  // Handle failure
  if (data.phase === "error" || data.progress === -1) {
    status.innerHTML = `<div class="status-line">❌ Upload failed</div><div>${data.error || "Unknown error"}</div>`;
    return;
  }

  // Update logo fill
  coloredContainer.style.width = `${data.progress}%`;

  // --- PHASE: ITEMS ---
  if (data.phase === "items") {
    status.innerHTML = `
      <div class="status-line">Create new Items${getDotHTML()}</div>
    `;
    setTimeout(updateProgress, 500);
    return;
  }

  // --- PHASE: RELATIONS ---
  if (data.phase === "relations") {
    status.innerHTML = `
      <div class="status-line">Create new Items ✅</div>
      <div class="status-line">Create new Statements${getDotHTML()}</div>
    `;
    setTimeout(updateProgress, 500);
    return;
  }

  // --- PHASE: DONE ---
  if (data.phase === "done" && data.done) {
    status.innerHTML = `
      <div class="status-line">Create new Items ✅</div>
      <div class="status-line">Create new Statements ✅</div>
      <div class="status-line">✅ Upload complete! Redirecting${getDotHTML()}</div>
    `;
    coloredContainer.style.width = "100%";

    if (data.redirect) {
      setTimeout(() => {
        window.location.href = data.redirect;
      }, 1500);
    }
    return;
  }

  // Keep polling if not done yet
  if (!data.done) {
    setTimeout(updateProgress, 1000);
  }
}

updateProgress();
</script>
{% endblock %}

